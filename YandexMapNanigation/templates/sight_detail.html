{% extends "base.html" %}

{% block title %}
  {{ sight.title }}
{% endblock %}

{% block extra_head %}
  <script src="https://api-maps.yandex.ru/2.1/?apikey=bfec4ecd-6701-4004-a90b-6cf129e6df20&lang=ru_RU" type="text/javascript"></script>
{% endblock %}

{% block content %}
<div class="container d-flex justify-content-center">
  <div class="card col-5">
    <div class="card-header">
      <h1>{{ sight.title }}</h1>
    </div>
    <div class="card-body">
      <p><b>Описание: {{ sight.description }}</b></p>
      <h6>Адрес: {{ sight.city }}, {{ sight.street }}, {{ sight.house_number }}</h6>
      <h6>Автор: {{ sight.author }}</h6>
      <div class="map-section">
        <div class="map-container">
          <div id="map" class="w-100" style="height: 400px;">
          </div>
        </div>
    </div>
    {% if request.user == sight.author %}
    <a class="btn btn-primary" href="{% url 'sight:edit' sight.id %}">Изменить запись</a>
    <a class="btn btn-primary" href="{% url 'sight:delete' sight.id %}">Удалить запись</a>
  {% endif %}
  <div class="container my-5">
    <form id="address-form">
      <div class="mb-3">
        <label for="address" class="form-label">Введите адрес:</label>
        <input type="text" id="address" class="form-control" placeholder="Например: Москва, улица Тверская, дом 7" required>
      </div>
      <button type="submit" class="btn btn-primary">Построить маршрут</button>
    </form>
  </div>
  </div>
</div>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    async function fetchCoordinatesAndInitMap() {
      try {
        const response = await fetch('https://geocode-maps.yandex.ru/v1/?apikey=bfec4ecd-6701-4004-a90b-6cf129e6df20&geocode={{ sight.city }}, улица {{ sight.street }}, дом {{ sight.house_number }}&format=json');
        const data = await response.json();

        const [longitude, latitude] = data.response.GeoObjectCollection.featureMember[0].GeoObject.Point.pos.split(" ");
        ymaps.ready(function() {
          const map = new ymaps.Map("map", {
            center: [latitude, longitude],
            zoom: 14,
            controls: ['zoomControl']
          });

          const placemark = new ymaps.Placemark([latitude, longitude], {
            hintContent: '{{ sight.title|escapejs }}',
            balloonContent: '{{ sight.description|escapejs }}'
          }, {
            preset: 'islands#greenDotIcon',
            iconColor: '#00CC00'
          });

          map.geoObjects.add(placemark);
        });

      } catch (error) {
        console.error('Ошибка при загрузке карты:', error);
      }
    }

    fetchCoordinatesAndInitMap();
  });
</script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('address-form');
  
  form.addEventListener('submit', async function(event) {
    event.preventDefault(); // чтобы не перезагружалась страница

    const address = document.getElementById('address').value.trim();
    if (!address) {
      alert('Пожалуйста, введите адрес.');
      return;
    }

    try {
      const response = await fetch(`https://geocode-maps.yandex.ru/v1/?apikey=bfec4ecd-6701-4004-a90b-6cf129e6df20&geocode=${encodeURIComponent(address)}&format=json`);
      const data = await response.json();

      const pos = data.response.GeoObjectCollection.featureMember[0].GeoObject.Point.pos.split(" ");
      const [user_longitude, user_latitude] = pos;

      const place_response = await fetch('https://geocode-maps.yandex.ru/v1/?apikey=bfec4ecd-6701-4004-a90b-6cf129e6df20&geocode={{ sight.city }}, улица {{ sight.street }}, дом {{ sight.house_number }}&format=json');
      const place_data = await place_response.json();

      const [place_longitude, place_latitude] = place_data.response.GeoObjectCollection.featureMember[0].GeoObject.Point.pos.split(" ");

      // Составляем ссылку на Яндекс.Карты
      const mapsLink = `https://yandex.ru/maps?rtext=${user_latitude}%2C${user_longitude}~${place_latitude}%2C${place_longitude}&rtt=pd`
      console.log(mapsLink)
      // Перенаправляем пользователя
      window.location.href = mapsLink;

    } catch (error) {
      console.error('Ошибка при поиске адреса:', error);
      alert('Не удалось найти адрес. Попробуйте ещё раз.');
    }
  });
});
  </script>
{% endblock %}